[SERVICE]
    Flush        1
    Log_Level    info
    Parsers_File parsers.conf

[INPUT]
    Name              tail
    Path              /var/log/eiah/*.log
    Tag               eiah.*
    DB                /var/log/eiah/fluent-bit.db
    Mem_Buf_Limit     10MB
    Refresh_Interval  5
    Skip_Long_Lines   On
    Parser            json

[FILTER]
    Name        modify
    Match       eiah.*
    Add         stack_name    ${STACK_NAME}
    Add         environment   ${ENVIRONMENT}

[FILTER]
    Name        nest
    Match       eiah.*
    Operation   lift
    Nested_under log

[FILTER]
    Name            record_modifier
    Match           eiah.*
    Record          service       $service
    Record          tenantId      $tenantId
    Record          workspaceId   $workspaceId
    Record          runId         $runId
    Record          costCents     $costCents
    Record          actionKind    $actionKind

[OUTPUT]
    Name            loki
    Match           eiah.*
    Url             ${LOKI_URL}
    TenantID        ${LOKI_TENANT}
    Labels          job=eiah,service=$service,tenant=$tenantId,workspace=$workspaceId
    Line_Format     json

[OUTPUT]
    Name            es
    Match           eiah.*
    Host            ${ELASTIC_HOST}
    Port            ${ELASTIC_PORT}
    Index           eiah-logs-%Y.%m.%d
    Type            _doc
    Logstash_Format On
